# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

このファイルは、このリポジトリで作業するClaude Code (claude.ai/code)にガイダンスを提供します。

## 言語設定
**重要**: このプロジェクトでは日本語で応答してください。すべてのコミュニケーションは日本語で行ってください。

## プロジェクト概要

ワイチャ！は、オンラインセミナー中に匿名でリアルタイム反応・質問投稿・回答機能を提供するセミナー反応システムです。アプリケーションの構成：

- **フロントエンド**: Next.js 14 + React + TypeScript
- **リアルタイム通信**: Socket.IOサーバー（開発: ポート3001、本番: $PORT+1）
- **スタイリング**: TailwindCSS
- **アーキテクチャ**: 独立したSocket.IOサーバー + Next.jsフロントエンド

## 開発コマンド

### セットアップ
```bash
npm install
```

### 開発
```bash
# 両方のサーバーを同時に起動
npm run dev-all

# または個別に起動
npm run server  # Socket.IOサーバー（ポート3001）
npm run dev     # Next.jsフロントエンド（ポート3000）
```

### 本番環境
```bash
npm run build
npm run start        # Socket.IOサーバー（$PORT+1）+ Next.jsサーバー（$PORT）
```

### リント・型チェック
```bash
npm run lint        # ESLint実行
npx tsc --noEmit    # TypeScript型チェック
```

## アーキテクチャ

### コアコンポーネント
- **ホームページ** (`src/app/page.tsx`): ルーム作成・参加インターフェース
- **ルームページ** (`src/app/room/[roomId]/page.tsx`): メインセミナールーム（反応ボタン付き）
- **Socket.IOサーバー** (`src/server.ts`): リアルタイム通信ハンドラー

### 主要機能の実装
- **匿名反応・質問・コメント**: ユーザー認証不要
- **投稿分類システム**: 質問とコメントを分けて管理
- **質問専用回答システム**: 質問のみに回答ボタンと回答機能
- **改行対応**: Shift+Enterで改行、textareaベースの入力
- **スクロール機能**: 過去の投稿をスクロールして確認
- **色分け反応**: 反応ごとに異なる色（へぇ=オレンジ、いいね=赤、？？？=黄、ぱちぱち=緑）
- **フローティングアニメーション**: 反応のみ背景に色分け表示
- **自動スクロール**: 最下部にいる時のみ新メッセージで自動スクロール
- **会話ログエクスポート**: JSON形式でダウンロード
- **リアルタイム通信**: Socket.IOによるルーム別メッセージ・回答配信
- **ルーム管理**: メモリベースのルーム保存（サーバー再起動時にリセット）

### ネットワーク設定（v2.1.1対応）
- `0.0.0.0`バインディングによるローカルネットワークアクセス対応
- Next.js開発サーバー: `npm run dev`で起動（`-H 0.0.0.0`で全インターフェースバインド）
- Socket.IOサーバー: `0.0.0.0:3001`でリッスン
- **動的ホスト名対応**: `window.location.hostname`を使用してIPアドレス変更に自動対応
- **環境変数対応**: `next.config.js`でSOCKET_HOST環境変数をサポート

### TypeScript設定
- パスマッピング: `@/*` -> `./src/*`
- strict modeを有効化
- tsx（TypeScript実行）を使用してサーバーファイルを直接実行

## 重要事項

- Socket.IOサーバーとNext.jsの両方を同時に起動する必要がある
- ルームデータ・回答データはメモリに保存され、サーバー再起動時に消失する
- 会話ログは手動でエクスポートする必要がある（自動保存なし）
- ローカルネットワーク使用専用に設計されている
- **v2.1.1更新**: Socket.IO接続URLは動的ホスト名対応（`window.location.hostname`使用）
- 反応は背景フローティング表示のみ、質問・コメントはチャットに表示
- 回答機能により双方向コミュニケーションが可能
- **IPアドレス変更対応**: 設定変更なしでネットワーク環境の変更に自動対応

## ファイル構造

```
src/
├── app/
│   ├── page.tsx              # ホームページ（ルーム作成・参加、即座リダイレクト）
│   ├── room/[roomId]/
│   │   └── page.tsx          # セミナールーム（チャット、回答、エクスポート）
│   └── globals.css           # TailwindCSS imports
├── server.ts                 # Socket.IOサーバー（回答・エクスポート機能含む）
└── ...
```

## 開発のヒント

- `npm run dev-all`で両方のサーバーを同時に起動
- Socket.IOサーバーは接続とルーム活動をログ出力
- メッセージ・回答はルームごとにメモリ内のMapに保存
- フローティングアニメーションは3秒間のCSSキーフレームを使用（反応のみ）
- 自動スクロールはuseRefとuseEffectで実装
- 回答システムはメッセージ構造にreplies配列を追加
- エクスポート機能はJSON形式でクライアントサイドダウンロード

## 最新の機能追加

### v2.1.2（Render本番環境対応）
- **本番環境ポート設定修正**：Socket.IOサーバーが$PORT+1で動作するよう修正
- **動的Socket.IO接続**：フロントエンドが本番環境で適切なポートに接続
- **環境判定対応**：NODE_ENV=productionでの本番モード判定
- **プロキシ設定改善**：Next.jsリライトルールの本番環境対応

### v2.1.1（ネットワーク対応強化）
- **動的ホスト名対応**：IPアドレス変更時の自動接続対応
- **全インターフェースバインド**：Next.js開発サーバーの`0.0.0.0`バインド
- **環境変数対応**：Socket.IOプロキシ設定の柔軟化
- **企業環境対応**：プロキシ環境でのアクセス改善

### v2.1（UI/UX改善）

#### UI/UX改善
- 投稿分類表示：質問（青）、コメント（緑）の色分け
- 改行対応：Shift+Enterで改行、whitespace-pre-wrapで改行保持
- スクロール機能：過去の投稿をスクロールして確認、美しいスクロールバー
- 文字の可読性向上：入力欄の文字色を濃く、プレースホルダーも見やすく
- 色分け反応：反応ごとに異なる色（オレンジ、赤、黄、緑）
- 回答ボタン：質問に明確な回答ボタンを追加

#### 新機能
- **投稿分類システム**：質問とコメントを分けて管理
- **質問専用回答機能**：質問のみに回答機能を提供
- **改行入力**：Shift+Enterでの改行対応
- **スクロール機能**：過去の投稿をスクロールして確認
- **色分け反応**：反応ごとに異なる色で表示

#### 技術的改善
- 投稿タイプ拡張：`type: 'question' | 'comment' | 'reaction'`
- textareaベースの入力：onKeyDownでShift+Enter制御
- スクロール実装：maxHeight制限とカスタムCSSスクロールバー
- 色分けシステム：TailwindCSSカラーパレットを活用
- UI改善：text-gray-900、placeholder-gray-500で視認性向上